{% extends "base.html" %}
{% block title %}Types d‚Äôemplacement ‚Äì Slottix{% endblock %}

{% block content %}
<div class="card shadow-lg">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">üè∑Ô∏è Types d‚Äôemplacement</h2>
    <div class="d-flex gap-2">
      <button id="btnRefresh" class="btn btn-light btn-sm">üîÑ Actualiser</button>
      <button id="btnAdd" class="btn btn-warning btn-sm fw-bold">‚ûï Nouveau type</button>
    </div>
  </div>

  <div class="card-body" style="padding:10px;">
    <div class="table-responsive">
      <table id="typesTable" class="table table-striped table-hover table-sm align-middle text-center"
             style="min-width: 800px; font-size: 0.9rem;">
        <thead class="table-dark">
          <tr>
            <th>Type1</th>
            <th>Type2</th>
            <th>Type3</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal cr√©ation -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚ûï Cr√©er un type d‚Äôemplacement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="addForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Type1</label>
            <input type="text" class="form-control" name="Type1" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Type2</label>
            <input type="text" class="form-control" name="Type2">
          </div>
          <div class="col-md-4">
            <label class="form-label">Type3</label>
            <input type="text" class="form-control" name="Type3">
          </div>
        </form>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="text-muted small">‚ö†Ô∏è Les trois niveaux de type permettent de d√©finir des cat√©gories hi√©rarchiques.</div>
        <div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmAdd" class="btn btn-success">Cr√©er</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal √©dition -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚úèÔ∏è Modifier un type d‚Äôemplacement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Type1</label>
            <input type="text" class="form-control" name="Type1" readonly>
          </div>
          <div class="col-md-4">
            <label class="form-label">Type2</label>
            <input type="text" class="form-control" name="Type2">
          </div>
          <div class="col-md-4">
            <label class="form-label">Type3</label>
            <input type="text" class="form-control" name="Type3">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button id="confirmEdit" class="btn btn-success">üíæ Enregistrer</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function () {
  // === Initialisation DataTable ===
  let table = $('#typesTable').DataTable({
    ajax: { url: "{{ url_for('api_types_emplacement_data') }}", dataSrc: '' },
    columns: [
      { data: 'Type1' },
      { data: 'Type2', render: d => d || '‚Äî' },
      { data: 'Type3', render: d => d || '‚Äî' },
      {
        data: null,
        orderable: false,
        searchable: false,
        render: row => {
          const t1 = row.Type1?.replace(/"/g,'&quot;') || '';
          const t2 = row.Type2?.replace(/"/g,'&quot;') || '';
          const t3 = row.Type3?.replace(/"/g,'&quot;') || '';
          return `
            <button class="btn btn-sm btn-outline-primary btn-edit me-1"
              data-t1="${t1}" data-t2="${t2}" data-t3="${t3}">
              ‚úèÔ∏è Modifier
            </button>
            <button class="btn btn-sm btn-outline-danger btn-del"
              data-t1="${t1}" data-t2="${t2}" data-t3="${t3}">
              üóëÔ∏è Supprimer
            </button>`;
        }
      }
    ],
    pageLength: 25,
    language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json" },
    order: [[0, 'asc']]
  });

  const showLoading = () => $('#loadingOverlay').removeClass('d-none');
  const hideLoading = () => $('#loadingOverlay').addClass('d-none');
  function reload() { table.ajax.reload(null, false); }

  $('#btnRefresh').on('click', reload);

  // === Cr√©ation ===
  const addModalEl = document.getElementById('addModal');
  const addModal = new bootstrap.Modal(addModalEl);

  $('#btnAdd').on('click', () => {
    $('#addForm')[0].reset();
    addModal.show();
  });

  $('#confirmAdd').on('click', async function(){
    const data = {
      type: $('input[name="Type1"]').val().trim(),
      designation: $('input[name="Type2"]').val().trim(),
      longueur: $('input[name="Type3"]').val().trim()
    };
    if(!data.type){ alert("Le champ Type1 est obligatoire."); return; }

    showLoading();
    try {
      const r = await fetch("{{ url_for('api_types_emplacement_add') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
      const j = await r.json();
      hideLoading();
      if(r.ok && j.status === "success"){
        addModal.hide();
        alert(j.message || "‚úÖ Type ajout√©.");
        reload();
      } else {
        alert(j.message || "‚ùå Erreur lors de l‚Äôajout.");
      }
    } catch(e){
      hideLoading();
      alert("‚ùå Erreur r√©seau.");
    }
  });

  // === Suppression ===
  $('#typesTable').on('click', '.btn-del', async function(){
    const t1 = $(this).data('t1');
    if(!confirm(`Supprimer d√©finitivement le type ¬´ ${t1} ¬ª ?`)) return;
    showLoading();
    try {
      const r = await fetch("{{ url_for('api_types_emplacement_delete') }}", {
        method: "DELETE",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({type: t1})
      });
      const j = await r.json();
      hideLoading();
      if(r.ok && j.status === "success"){
        alert(j.message || "üóë Type supprim√©.");
        reload();
      } else {
        alert(j.message || "‚ùå Erreur lors de la suppression.");
      }
    } catch(e){
      hideLoading();
      alert("‚ùå Erreur r√©seau.");
    }
  });

  // === √âdition ===
  const editModalEl = document.getElementById('editModal');
  const editModal = new bootstrap.Modal(editModalEl);

  $('#typesTable').on('click', '.btn-edit', function(){
    const t1 = $(this).data('t1');
    const t2 = $(this).data('t2');
    const t3 = $(this).data('t3');

    $('#editForm input[name="Type1"]').val(t1);
    $('#editForm input[name="Type2"]').val(t2);
    $('#editForm input[name="Type3"]').val(t3);
    editModal.show();
  });

  $('#confirmEdit').on('click', async function(){
    const data = {
      type: $('#editForm input[name="Type1"]').val().trim(),
      designation: $('#editForm input[name="Type2"]').val().trim(),
      longueur: $('#editForm input[name="Type3"]').val().trim()
    };
    showLoading();
    try {
      const r = await fetch("{{ url_for('api_types_emplacement_add') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
      const j = await r.json();
      hideLoading();
      if(r.ok && j.status === "success"){
        alert("‚úÖ Type mis √† jour.");
        editModal.hide();
        reload();
      } else {
        alert(j.message || "‚ùå Erreur lors de la mise √† jour.");
      }
    } catch(e){
      hideLoading();
      alert("‚ùå Erreur r√©seau.");
    }
  });

});
</script>

<!-- üïí Overlay de chargement -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center;">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-primary">‚è≥ Traitement en cours...</div>
  </div>
</div>
{% endblock %}
