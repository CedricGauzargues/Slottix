{% extends "base.html" %}
{% block title %}üî• Ventes exceptionnelles par r√©f√©rence ‚Äì Slottix{% endblock %}

{% block content %}
<div class="card shadow-lg">
  <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">üî• Ventes exceptionnelles par r√©f√©rence</h2>
    <div class="d-flex gap-2">
      <button id="btnRefresh" class="btn btn-light btn-sm">üîÑ Actualiser</button>
      <button id="btnAdd" class="btn btn-warning btn-sm fw-bold">‚ûï Nouvelle vente</button>
    </div>
  </div>

  <div class="card-body" style="padding:10px;">
    <div class="table-responsive">
      <table id="ventesTable" class="table table-striped table-hover table-sm align-middle text-center"
             style="min-width: 1000px; font-size: 0.9rem;">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>R√©f√©rence</th>
            <th>√âvolution (%)</th>
            <th>Qt√© en +</th>
            <th>Lignes Prep +</th>
            <th>Date du</th>
            <th>Date au</th>
            <th>Type Flux</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal ajout/modif -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">‚ûï Nouvelle vente exceptionnelle</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="addForm" class="row g-3">
          <!-- ü©µ champs cach√©s pour suivre le mode et l‚ÄôID -->
          <input type="hidden" name="mode" value="add">
          <input type="hidden" name="IDEvenementRef" value="">

          <div class="col-md-4">
            <label class="form-label">R√©f√©rence</label>
            <input type="text" class="form-control" name="Reference" id="refInput"
              placeholder="Saisir une r√©f√©rence existante" required>
            <div class="form-text text-muted">La r√©f√©rence doit exister dans la base produits.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">√âvolution (%)</label>
            <input type="number" class="form-control" name="EvolutionPct" step="0.01" placeholder="ex : 4.5 pour +4,5 %">
          </div>

          <div class="col-md-4">
            <label class="form-label">Qt√© en plus</label>
            <input type="number" class="form-control" name="Qte_en_plus" placeholder="ex : 200">
          </div>

          <div class="col-md-4">
            <label class="form-label">Lignes Prep en plus (facultatif)</label>
            <input type="number" class="form-control" name="LignesPrepEnPlus" placeholder="ex : 50">
          </div>

          <div class="col-md-4">
            <label class="form-label">Date du</label>
            <input type="date" class="form-control" name="DateDu" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Date au</label>
            <input type="date" class="form-control" name="DateAu" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Type de flux</label>
            <select name="TypeFlux" class="form-select" id="fluxSelect">
              <option value="Tous">Tous</option>
            </select>
            <div class="form-text">Si non renseign√©, le TypeFlux sera d√©fini √† <strong>"Tous"</strong>.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="text-muted small">Remplir soit <b>√âvolution%</b>, soit <b>Qt√© en plus</b>, jamais les deux.</div>
        <div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmAdd" class="btn btn-success">üíæ Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function () {
  let table = $('#ventesTable').DataTable({
    ajax: { url: "{{ url_for('api_ventes_exceptionnelles_ref_data') }}", dataSrc: '' },
    columns: [
      { data: 'IDEvenementRef' },
      { data: 'Reference' },
      { data: 'Evolution', render: d => d !== null && d !== undefined ? d + ' %' : '‚Äî' },
      { data: 'Qte_en_plus', render: d => d || '‚Äî' },
      { data: 'LignesPrepEnPlus', render: d => d || '‚Äî' },
      { data: 'DateDu' },
      { data: 'DateAu' },
      { data: 'TypeFlux', render: d => d || '<span class="text-muted">Tous</span>' },
      {
        data: null,
        orderable: false,
        searchable: false,
        render: row => `
          <button class="btn btn-sm btn-outline-primary btn-edit me-1" data-id="${row.IDEvenementRef}">‚úèÔ∏è Modifier</button>
          <button class="btn btn-sm btn-outline-danger btn-del" data-id="${row.IDEvenementRef}">üóëÔ∏è Supprimer</button>`
      }
    ],
    pageLength: 25,
    language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json" },
    order: [[0, 'desc']]
  });

  const showLoading = () => $('#loadingOverlay').removeClass('d-none');
  const hideLoading = () => $('#loadingOverlay').addClass('d-none');
  const reload = () => table.ajax.reload(null, false);
  $('#btnRefresh').on('click', reload);

  const addModalEl = document.getElementById('addModal');
  const addModal = new bootstrap.Modal(addModalEl);

  // ü©µ Bouton "Nouvelle vente"
  $('#btnAdd').on('click', async function(){
    $('#addForm')[0].reset();
    $('#addForm [name="mode"]').val('add'); // reset mode
    $('#addForm [name="IDEvenementRef"]').val('');
    $('input[name="EvolutionPct"], input[name="Qte_en_plus"]').prop('disabled', false);

    try {
      const res = await fetch("{{ url_for('api_ventes_exceptionnelles_ref_options') }}");
      const j = await res.json();
      const fluxSel = $('#fluxSelect').empty().append('<option value="Tous">Tous</option>');
      (j.typeflux || []).forEach(f => fluxSel.append(`<option value="${f}">${f}</option>`));
    } catch(e){
      alert("‚ùå Erreur chargement des options."); return;
    }

    $('#addModal .modal-title').text('‚ûï Nouvelle vente exceptionnelle');
    addModal.show();
  });

  // üîÑ Liens dynamiques entre EvolutionPct et Qte_en_plus
  $('input[name="EvolutionPct"]').on('input', function(){
    $('input[name="Qte_en_plus"]').prop('disabled', !!$(this).val());
  });
  $('input[name="Qte_en_plus"]').on('input', function(){
    $('input[name="EvolutionPct"]').prop('disabled', !!$(this).val());
  });

  // üíæ Enregistrement (cr√©ation ou modification)
  $('#confirmAdd').on('click', async function(){
    const formData = new FormData($('#addForm')[0]);
    const form = Object.fromEntries(formData);
    const mode = form.mode;
    const id = form.IDEvenementRef;

    form.Evolution = form.EvolutionPct || null;
    delete form.EvolutionPct;

    if (!form.Reference){ alert("La r√©f√©rence est obligatoire."); return; }
    if (!form.DateDu || !form.DateAu){ alert("Les dates sont obligatoires."); return; }
    if (new Date(form.DateAu) < new Date(form.DateDu)){ alert("La date de fin doit √™tre post√©rieure ou √©gale √† la date de d√©but."); return; }
    if (form.Evolution && form.Qte_en_plus){ alert("Remplir soit √âvolution%, soit Qt√© en plus, pas les deux."); return; }
    if (!form.Evolution && !form.Qte_en_plus){ alert("Veuillez remplir au moins un champ de variation."); return; }

    form.TypeFlux = form.TypeFlux || "Tous";

    const endpoint = (mode === 'edit')
      ? "{{ url_for('api_ventes_exceptionnelles_ref_update') }}" // ü©µ fix : route correcte pour update
      : "{{ url_for('api_ventes_exceptionnelles_ref_add') }}";

    try {
      showLoading();
      const r = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form)
      });
      const j = await r.json();
      hideLoading();

      if (r.ok && j.status === "success") {
        alert(j.message);
        bootstrap.Modal.getInstance(addModalEl).hide(); // ü©µ fix : fermeture propre
        reload();
      } else {
        alert(j.message || "‚ùå Erreur d‚Äôenregistrement.");
      }
    } catch(e){
      hideLoading();
      console.error(e);
      alert("‚ùå Erreur r√©seau.");
    }
  });

  // ‚úèÔ∏è Bouton Modifier
  $('#ventesTable').on('click', '.btn-edit', async function(){
    const id = $(this).data('id');
    if (!id) { alert("‚ö†Ô∏è ID introuvable."); return; }

    try {
      showLoading();
      const res = await fetch(`/api/ventes_exceptionnelles_ref_get/${id}`);
      const j = await res.json();
      hideLoading();

      if (!res.ok || j.status === "error") {
        alert(j.message || "‚ùå Erreur r√©seau lors du chargement de la ligne.");
        return;
      }

      const d = j.data;
      $('#addForm')[0].reset();
      $('#addForm [name="mode"]').val('edit');
      $('#addForm [name="IDEvenementRef"]').val(d.IDEvenementRef);
      $('#addForm [name="Reference"]').val(d.Reference);
      $('#addForm [name="EvolutionPct"]').val(d.Evolution || '');
      $('#addForm [name="Qte_en_plus"]').val(d.Qte_en_plus || '');
      $('#addForm [name="LignesPrepEnPlus"]').val(d.LignesPrepEnPlus || '');
      $('#addForm [name="DateDu"]').val(d.DateDu);
      $('#addForm [name="DateAu"]').val(d.DateAu);
      $('#addForm [name="TypeFlux"]').val(d.TypeFlux || 'Tous');

      $('input[name="EvolutionPct"], input[name="Qte_en_plus"]').prop('disabled', false);
      if (d.Evolution) $('input[name="Qte_en_plus"]').prop('disabled', true);
      if (d.Qte_en_plus) $('input[name="EvolutionPct"]').prop('disabled', true);

      $('#addModal .modal-title').text('‚úèÔ∏è Modifier une vente exceptionnelle');
      addModal.show();
    } catch (e) {
      hideLoading();
      console.error(e);
      alert("‚ùå Erreur r√©seau lors du chargement de la ligne.");
    }
  });

  // üóë Suppression
  $('#ventesTable').on('click', '.btn-del', async function(){
    const id = $(this).data('id');
    if(!confirm(`Supprimer l‚Äô√©v√©nement #${id} ?`)) return;
    try {
      showLoading();
      const r = await fetch("{{ url_for('api_ventes_exceptionnelles_ref_delete') }}", {
        method: "DELETE", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({IDEvenementRef: id})
      });
      const j = await r.json();
      hideLoading();
      if(r.ok && j.status === "success"){
        alert(j.message);
        reload();
      } else {
        alert(j.message || "‚ùå Erreur suppression.");
      }
    } catch(e){
      hideLoading();
      alert("‚ùå Erreur r√©seau.");
    }
  });
});
</script>

<!-- Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center;">
  <div class="text-center">
    <div class="spinner-border text-danger" style="width:3rem; height:3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-danger">‚è≥ Traitement en cours...</div>
  </div>
</div>
{% endblock %}
