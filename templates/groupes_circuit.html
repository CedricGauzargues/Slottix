{% extends "base.html" %}
{% block title %}Groupes de circuits â€“ Slottix{% endblock %}

{% block content %}
<div class="card shadow-lg">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">ğŸ”— Groupes de circuits</h2>
    <div class="d-flex gap-2">
      <button id="btnRefresh" class="btn btn-light btn-sm">ğŸ”„ Actualiser</button>
      <button id="btnAdd" class="btn btn-warning btn-sm fw-bold">â• Nouveau groupe</button>
    </div>
  </div>

  <div class="card-body" style="padding:10px;">
    <div class="table-responsive">
      <table id="groupesTable" class="table table-striped table-hover table-sm align-middle text-center"
             style="min-width: 900px; font-size: 0.9rem;">
        <thead class="table-dark">
          <tr>
            <th>Groupe</th>
            <th>DÃ©signation</th>
            <th>Circuits</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal crÃ©ation -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">â• CrÃ©er un groupe de circuits</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="addForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Nom du groupe</label>
            <input type="text" class="form-control" name="groupe" required>
          </div>
          <div class="col-md-8">
            <label class="form-label">DÃ©signation</label>
            <input type="text" class="form-control" name="designation" placeholder="(facultatif)">
          </div>

          <div class="col-12">
            <label class="form-label">Circuits Ã  inclure</label>
            <select multiple class="form-select" size="10" name="circuits" id="circuitsSelect"></select>
            <div class="form-text">Astuce : Ctrl/Cmd + clic pour sÃ©lection multiple.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="text-muted small">Un circuit ne peut appartenir quâ€™Ã  un seul groupe.</div>
        <div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmAdd" class="btn btn-success">CrÃ©er</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ã©dition -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">âœï¸ Modifier le groupe de circuits</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Nom du groupe</label>
            <input type="text" class="form-control" name="groupe" readonly>
          </div>
          <div class="col-md-8">
            <label class="form-label">DÃ©signation</label>
            <input type="text" class="form-control" name="designation">
          </div>
          <div class="col-12">
            <label class="form-label">Circuits Ã  inclure</label>
            <select multiple class="form-select" size="10" name="circuits" id="editCircuitsSelect"></select>
            <div class="form-text">Astuce : Ctrl/Cmd + clic pour sÃ©lection multiple.</div>
            <div class="text-muted small mt-1">Un circuit ne peut appartenir quâ€™Ã  un seul groupe.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button id="confirmEdit" class="btn btn-success">ğŸ’¾ Enregistrer</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function () {
  let table = $('#groupesTable').DataTable({
    ajax: { url: "{{ url_for('api_groupes_circuit_data') }}", dataSrc: '' },
    columns: [
      { data: 'GroupeCircuit' },
      { data: 'DesignationGroupeCircuit', render: d => d || 'â€”' },
      {
        data: 'Circuits',
        render: arr => {
          const list = (arr || []).map(c => `<span class="badge bg-secondary me-1 mb-1">${c}</span>`).join(' ');
          return list || '<span class="text-muted">Aucun</span>';
        }
      },
      {
        data: null,
        orderable: false,
        searchable: false,
        render: row => {
          const g = row.GroupeCircuit?.replace(/"/g,'&quot;') || '';
          const d = row.DesignationGroupeCircuit?.replace(/"/g,'&quot;') || '';
          return `
            <button class="btn btn-sm btn-outline-primary btn-edit me-1" data-groupe="${g}" data-designation="${d}">âœï¸ Modifier</button>
            <button class="btn btn-sm btn-outline-danger btn-del" data-groupe="${g}">ğŸ—‘ï¸ Supprimer</button>
          `;
        }
      }
    ],
    pageLength: 25,
    language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json" },
    order: [[0, 'asc']]
  });

  const showLoading = () => $('#loadingOverlay').removeClass('d-none');
  const hideLoading = () => $('#loadingOverlay').addClass('d-none');

  function reload() { table.ajax.reload(null, false); }
  $('#btnRefresh').on('click', reload);

  // --- CrÃ©ation ---
  const addModalEl = document.getElementById('addModal');
  const addModal = new bootstrap.Modal(addModalEl);

  $('#btnAdd').on('click', async function(){
    $('#addForm')[0].reset();
    try {
      const r = await fetch("{{ url_for('api_groupes_circuit_circuits_options') }}");
      const j = await r.json();
      const sel = $('#circuitsSelect').empty();
      (j.circuits || []).forEach(c => sel.append(`<option value="${c}">${c}</option>`));
    } catch(e) { alert("âŒ Erreur de chargement des circuits."); return; }
    addModal.show();
  });

  $('#confirmAdd').on('click', async function(){
    const groupe = $('input[name="groupe"]').val().trim();
    const designation = $('input[name="designation"]').val().trim();
    const circuits = Array.from($('#circuitsSelect')[0].selectedOptions).map(o => o.value);
    if(!groupe){ alert("Le nom du groupe est obligatoire."); return; }
    if(!circuits.length){ alert("Veuillez sÃ©lectionner au moins un circuit."); return; }

    showLoading();
    try {
      const r = await fetch("{{ url_for('api_groupes_circuit_add') }}", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({groupe, designation, circuits})
      });
      const j = await r.json();
      if(r.ok && j.status === "success"){ addModal.hide(); alert(j.message); reload(); }
      else alert(j.message || "âŒ Erreur lors de la crÃ©ation.");
    } catch(e){ alert("âŒ Erreur rÃ©seau."); }
    finally { hideLoading(); }
  });

  // --- Suppression ---
  $('#groupesTable').on('click', '.btn-del', async function(){
    const groupe = $(this).data('groupe');
    if(!confirm(`Supprimer dÃ©finitivement le groupe Â« ${groupe} Â» ?`)) return;

    showLoading();
    try {
      const r = await fetch("{{ url_for('api_groupes_circuit_delete') }}", {
        method: "DELETE", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({groupe})
      });
      const j = await r.json();
      if(r.ok && j.status === "success"){ alert(j.message); reload(); }
      else alert(j.message || "âŒ Erreur suppression.");
    } catch(e){ alert("âŒ Erreur rÃ©seau."); }
    finally { hideLoading(); }
  });

  // --- Ã‰dition ---
  const editModalEl = document.getElementById('editModal');
  const editModal = new bootstrap.Modal(editModalEl);

  $('#groupesTable').on('click', '.btn-edit', async function(){
    const groupe = $(this).data('groupe');
    const designation = $(this).data('designation');
    $('#editForm input[name="groupe"]').val(groupe);
    $('#editForm input[name="designation"]').val(designation);

    try {
      const [r1, r2] = await Promise.all([
        fetch("{{ url_for('api_groupes_circuit_circuits_options') }}"),
        fetch("{{ url_for('api_groupes_circuit_data') }}")
      ]);
      const free = await r1.json();
      const allGroups = await r2.json();
      const group = allGroups.find(g => g.GroupeCircuit === groupe);
      const assigned = group ? group.Circuits : [];

      const sel = $('#editCircuitsSelect').empty();
      assigned.forEach(c => sel.append(`<option value="${c}" selected>${c}</option>`));
      (free.circuits || []).forEach(c => { if(!assigned.includes(c)) sel.append(`<option value="${c}">${c}</option>`); });
    } catch(e){ alert("âŒ Erreur de chargement circuits."); return; }

    editModal.show();
  });

  // âœ… Permettre la suppression locale dâ€™un circuit avec la touche Suppr
  $('#editCircuitsSelect').on('keydown', function(e){
    if(e.key === "Delete" || e.key === "Backspace"){
      const selected = Array.from(this.selectedOptions);
      selected.forEach(opt => opt.remove());
      e.preventDefault();
    }
  });

  $('#confirmEdit').on('click', async function(){
    const groupe = $('#editForm input[name="groupe"]').val();
    const designation = $('#editForm input[name="designation"]').val();
    const circuits = Array.from($('#editCircuitsSelect')[0].options).map(o => o.value);
    if(!circuits.length){ alert("Veuillez sÃ©lectionner au moins un circuit."); return; }

    showLoading();
    try {
      const r = await fetch("{{ url_for('api_groupes_circuit_add') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({groupe, designation, circuits})
      });
      const j = await r.json();
      if(r.ok && j.status === "success"){
        alert("âœ… Groupe mis Ã  jour.");
        editModal.hide();
        reload();
      } else {
        alert(j.message || "âŒ Erreur lors de la mise Ã  jour.");
      }
    } catch(e){
      console.error(e);
      alert("âŒ Erreur rÃ©seau.");
    } finally { hideLoading(); }
  });

});
</script>

<!-- ğŸ•’ Overlay de chargement -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center;">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-primary">â³ Traitement en cours...</div>
  </div>
</div>

{% endblock %}
