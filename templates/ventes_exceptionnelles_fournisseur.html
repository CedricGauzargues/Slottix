{% extends "base.html" %}
{% block title %}üè≠ Ventes exceptionnelles par fournisseur ‚Äì Slottix{% endblock %}

{% block content %}
<div class="card shadow-lg">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">üè≠ Ventes exceptionnelles par fournisseur</h2>
    <div class="d-flex gap-2">
      <button id="btnRefresh" class="btn btn-light btn-sm">üîÑ Actualiser</button>
      <button id="btnAdd" class="btn btn-warning btn-sm fw-bold">‚ûï Nouvelle vente</button>
    </div>
  </div>

  <div class="card-body" style="padding:10px;">
    <div class="table-responsive">
      <table id="ventesTable" class="table table-striped table-hover table-sm align-middle text-center"
             style="min-width: 1000px; font-size: 0.9rem;">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>N¬∞ Fournisseur</th>
            <th>Nom Fournisseur</th>
            <th>√âvolution (%)</th>
            <th>Date du</th>
            <th>Date au</th>
            <th>Type Flux</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal ajout/modif -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚ûï Nouvelle vente exceptionnelle fournisseur</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="addForm" class="row g-3">
          <input type="hidden" name="IDEvenementFournisseur">
          <input type="hidden" name="mode" value="add">

          <div class="col-md-4">
            <label class="form-label">N¬∞ Fournisseur</label>
            <input type="text" class="form-control" name="NFournisseur" id="nFournisseurInput"
                   placeholder="Saisir le n¬∞ fournisseur" required>
            <div class="form-text text-muted">Doit exister dans la base produits.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Nom Fournisseur</label>
            <input type="text" class="form-control" name="NomFournisseur" id="nomFournisseurInput"
                   placeholder="Nom du fournisseur" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">√âvolution (%)</label>
            <input type="number" class="form-control" name="Evolution" step="0.01" placeholder="ex : 4.5 pour +4,5 %" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Date du</label>
            <input type="date" class="form-control" name="DateDu" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Date au</label>
            <input type="date" class="form-control" name="DateAu" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Type de flux</label>
            <select name="TypeFlux" class="form-select" id="fluxSelect">
              <option value="Tous">Tous</option>
            </select>
            <div class="form-text">Si non renseign√©, le TypeFlux sera d√©fini √† <strong>"Tous"</strong>.</div>
          </div>
        </form>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <div class="text-muted small">Remplir les champs puis enregistrer pour valider.</div>
        <div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="confirmAdd" class="btn btn-success">üíæ Enregistrer</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function () {
  // === Tableau ===
  let table = $('#ventesTable').DataTable({
    ajax: { url: "{{ url_for('api_ventes_fournisseur_data') }}", dataSrc: '' },
    columns: [
      { data: 'IDEvenementFournisseur' },
      { data: 'NFournisseur' },
      { data: 'NomFournisseur' },
      { data: 'Evolution', render: d => d ? d + ' %' : '‚Äî' },
      { data: 'DateDu' },
      { data: 'DateAu' },
      { data: 'TypeFlux', render: d => d || '<span class="text-muted">Tous</span>' },
      {
  data: null, orderable: false, searchable: false,
  render: row => `
    <div style="white-space: nowrap;">
      <button class="btn btn-sm btn-outline-primary btn-edit me-1" data-id="${row.IDEvenementFournisseur}">‚úèÔ∏è Modifier</button>
      <button class="btn btn-sm btn-outline-danger btn-del" data-id="${row.IDEvenementFournisseur}">üóëÔ∏è Supprimer</button>
    </div>`
}

    ],
    pageLength: 25,
    language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json" },
    order: [[0, 'desc']]
  });

  const reload = () => table.ajax.reload(null, false);
  $('#btnRefresh').on('click', reload);

  const addModalEl = document.getElementById('addModal');
  const addModal = new bootstrap.Modal(addModalEl);

  // === Bouton Ajouter ===
  $('#btnAdd').on('click', async function(){
    $('#addForm')[0].reset();
    $('#addForm [name="mode"]').val('add');
    $('#addForm [name="IDEvenementFournisseur"]').val('');

    try {
      const res = await fetch("{{ url_for('api_ventes_fournisseur_options') }}");
      const j = await res.json();

      const fluxSel = $('#fluxSelect').empty().append('<option value="Tous">Tous</option>');
      (j.typeflux || []).forEach(f => fluxSel.append(`<option value="${f}">${f}</option>`));
    } catch(e){
      alert("‚ùå Erreur chargement des options."); return;
    }

    $('#addModal .modal-title').text('‚ûï Nouvelle vente exceptionnelle fournisseur');
    addModal.show();
  });

  // === Recherche fournisseur automatique ===
  async function lookupFournisseur(champ, valeur) {
    if (!valeur) return;
    try {
      const res = await fetch(`/api/ventes_fournisseur_lookup?term=${encodeURIComponent(valeur)}`);
      const data = await res.json();
      if (data.length > 0) {
        const f = data[0];
        $('#addForm [name="NFournisseur"]').val(f.NFournisseur);
        $('#addForm [name="NomFournisseur"]').val(f.NomFournisseur);
      }
    } catch (e) { console.error(e); }
  }

  $('#nFournisseurInput').on('blur', function() { lookupFournisseur('NFournisseur', $(this).val()); });
  $('#nomFournisseurInput').on('blur', function() { lookupFournisseur('NomFournisseur', $(this).val()); });

  // === Validation des dates ===
  function validateDates(du, au) {
    if (!du || !au) return true;
    return new Date(au) >= new Date(du);
  }

  // === Enregistrer (ajout ou modif) ===
  $('#confirmAdd').on('click', async function(){
    const form = Object.fromEntries(new FormData($('#addForm')[0]));
    const mode = form.mode;

    if (!form.NFournisseur && !form.NomFournisseur){ alert("Veuillez renseigner un fournisseur."); return; }
    if (!form.Evolution){ alert("Veuillez saisir une √©volution."); return; }
    if (!form.DateDu || !form.DateAu){ alert("Les dates sont obligatoires."); return; }
    if (!validateDates(form.DateDu, form.DateAu)){ alert("La date de fin doit √™tre post√©rieure √† la date de d√©but."); return; }

    form.TypeFlux = form.TypeFlux || "Tous";

    const endpoint = (mode === 'edit')
        ? "{{ url_for('api_ventes_fournisseur_update') }}"
        : "{{ url_for('api_ventes_fournisseur_add') }}";

    try {
      const r = await fetch(endpoint, {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify(form)
      });
      const j = await r.json();

      if(r.ok && j.status === "success"){
        alert(j.message);
        addModal.hide();
        reload();
      } else {
        alert(j.message || "‚ùå Erreur d‚Äôenregistrement.");
      }
    } catch(e){
      console.error(e);
      alert("‚ùå Erreur r√©seau.");
    }
  });

  // === Modifier ===
  $('#ventesTable').on('click', '.btn-edit', async function(){
    const id = $(this).data('id');
    try {
      const res = await fetch(`/api/ventes_fournisseur_get/${id}`);
      const j = await res.json();
      if(!res.ok || j.status === "error"){ alert(j.message || "Erreur chargement ligne."); return; }

      const d = j.data;
      $('#addForm')[0].reset();
      $('#addForm [name="mode"]').val('edit');
      $('#addForm [name="IDEvenementFournisseur"]').val(d.IDEvenementFournisseur);
      $('#addForm [name="NFournisseur"]').val(d.NFournisseur);
      $('#addForm [name="NomFournisseur"]').val(d.NomFournisseur);
      $('#addForm [name="Evolution"]').val(d.Evolution);
      $('#addForm [name="DateDu"]').val(d.DateDu);
      $('#addForm [name="DateAu"]').val(d.DateAu);
      $('#addForm [name="TypeFlux"]').val(d.TypeFlux || 'Tous');

      $('#addModal .modal-title').text('‚úèÔ∏è Modifier une vente exceptionnelle fournisseur');
      addModal.show();
    } catch(e){
      console.error(e);
      alert("‚ùå Erreur r√©seau lors du chargement de la ligne.");
    }
  });

  // === Supprimer ===
  $('#ventesTable').on('click', '.btn-del', async function(){
    const id = $(this).data('id');
    if(!confirm(`Supprimer l‚Äô√©v√©nement fournisseur #${id} ?`)) return;
    try {
      const r = await fetch("{{ url_for('api_ventes_fournisseur_delete') }}", {
        method: "DELETE", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({IDEvenementFournisseur: id})
      });
      const j = await r.json();
      if(r.ok && j.status === "success"){ alert(j.message); reload(); }
      else alert(j.message || "‚ùå Erreur suppression.");
    } catch(e){ alert("‚ùå Erreur r√©seau."); }
  });
});
</script>

<!-- Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center;">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-primary">‚è≥ Traitement en cours...</div>
  </div>
</div>
{% endblock %}
